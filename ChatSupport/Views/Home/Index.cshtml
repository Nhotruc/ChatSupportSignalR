@{
    ViewBag.Title = "Home Page";
}

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css'>
    <link href="~/Content/css.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>

    <div>
        <button id="openchat-button" class="btn btn-info"><span class="far fa-comment-dots"></span> </button>
    </div>
    <script>
        $(document).ready(function () {
            var firtTime = true;
            $("#openchat-button").click(function () {
                $(this).hide();
                $(".chat-window").show("slow");
                if (firstTime) {
                    $('#firstTime').text(getCurrentTime())
                    firstTime = false;

                }
            })
            $("#minim_chat_window").click(function () {
                $(".chat-window").hide("slow");
                $("#openchat-button").show("slow");
            })
        });
    </script>
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        var messages = [];
        function getCurrentTime() {
            var date = new Date();
            //var str = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
            var currentTimeFormat = date.getHours() + 'h' + date.getMinutes()
            return currentTimeFormat;
        }
        $(function () {
            var idSession = '@Session["idSessionConnect"].ToString()';
            var startSave = false;
            var name = null;


            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;

            // Create a function that the hub can call to broadcast messages.
            chat.client.receive = function (type, message) {
                console.log('receive is call')
                console.log('type' + type + ' message' + message)
                if (type == 'admin')
                    addMessageAdmin(message, getCurrentTime());
                else
                    addMessageCustomer(message);
            };

            function saveData() {
                localStorage.setItem('idSession',idSession);
                setInterval(function () {
                    if (!name) return;
                    //localStorage.setItem('timeUpdate', new Date().getTime());
                    localStorage.setItem('name', name);
                    var db = JSON.stringify(messages);
                    localStorage.setItem('db', db);

                }, 1000)
            }
            function restoreData() {
                var savedIdSession = localStorage.getItem('idSession');
                if (savedIdSession != null && savedIdSession != idSession) {
                    localStorage.clear();
                }
                //var time = localStorage.getItem('timeUpdate');
                var db = localStorage.getItem('db');
                if (db == null)
                    return;
                //if (!db || !time) return;

                //var timeDiff = new Date().getTime() - time;
                //var daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                //if (daysDiff > 0) {
                //    localStorage.removeItem('db');
                //    return;
                //}

                name = localStorage.getItem('name');

                var messages = JSON.parse(db);

                for (var i = 0; i < messages.length; i++) {
                    var message = messages[i];
                    if (message.type == 'customer') {
                        addMessageCustomer(message.message);
                    } else {
                        addMessageAdmin(message.message, message.time);
                    }
                }
            }


            function checkExistsName() {
                if (name == null) {
                    var temp = localStorage.getItem('name');
                    if (temp != null)
                        name = temp;
                    else
                        name = prompt('Tên của bạn là:');
                    if (name == null) {
                        alert('Tin nhắn không được gửi');
                        return false;
                    }
                }
                return true;
            }

            function handlerSend() {
                if (!checkExistsName()) {
                    return;
                }
                var message = $('#txt-input').val()
                if ($.trim(message) == "")
                    return;
                chat.server.sendToAdmin(idSession, name, message);
                addMessageCustomer(message);
                $('#txt-input').val('').focus();
            }

            function connectHubCallback() {
                restoreData();
                saveData();
                $('#btn-chat').click(handlerSend);

                $('#txt-input').on('keypress', function (e) {

                    if (e.which === 13) {
                        handlerSend()
                    }
                });
            }



            function addMessageCustomer(message) {
                messages.push({ type: 'customer', message: message })
                $(".msg_container_base").append('<div class="row msg_container base_sent"> ' +
                    ' <div class="col-md-10 col-xs-10 nopadding">' +
                       ' <div class="messages msg_sent"> ' +
                           ' <p>' + message + '</p> ' +
                       ' </div> ' +
                   ' </div> ' +
                   ' <div class="col-md-2 col-xs-2 nopadding avatar"> ' +
                       ' <div class="avatar-info"> ' +
                           ' <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1qvejRMnu6IgbYSK0ZrgiBhSOFi55mnu50CZWLllR1nPF_vqw" class=" img-responsive "> ' +
                           ' <div class="nickname">' + name + '</div> ' +
                       ' </div> ' +
                   ' </div> ' +
                ' </div>').scrollTop(1000000);
            }

            function addMessageAdmin(message, time) {
                messages.push({ type: 'admin', message: message, time: time })
                $(".msg_container_base").append(
                    '<div class="row msg_container base_receive"> ' +
                        '<div class="col-md-2 col-xs-2 nopadding avatar"> ' +
                            '<div class="avatar-info"> ' +
                               ' <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1qvejRMnu6IgbYSK0ZrgiBhSOFi55mnu50CZWLllR1nPF_vqw" class=" img-responsive "> ' +
                               ' <div class="nickname">Nhân viên hỗ trợ</div> ' +
                          '  </div> ' +
                      '  </div> ' +
                       ' <div class="col-md-10 col-xs-10 nopadding"> ' +
                         '   <div class="messages msg_receive"> ' +
                             '   <p> ' +
                                   message +
                            '    </p> ' +
                            '    <time>' + time + '</time> ' +
                          '  </div> ' +
                      '  </div> ' +
                    '</div> ').scrollTop(1000000);
            }

            $.connection.hub.qs = { "idSession": idSession };
            $.connection.hub.start().done(connectHubCallback);
        })
    </script>
    <div class="row chat-window col-xs-4 col-md-4 nopadding" style="display:none">
        <div class="col-xs-12 col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading top-bar">
                    <div class="col-md-8 col-xs-8">
                        <h3 class="panel-title"><span class="glyphicon glyphicon-comment"></span> Hỗ trợ khách hàng</h3>
                        <h5 style="color: lightslategray"> Nhân viên hỗ trợ: Admin</h5>
                    </div>
                    <div class="col-md-4 col-xs-4" style="text-align: right;" title="Ẩn xuống phía dưới">
                        <a><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a>
                    </div>
                </div>
                <div class="panel-body msg_container_base">
                    <div class="row msg_container base_receive">
                        <div class="col-md-2 col-xs-2 nopadding avatar">
                            <div class="avatar-info">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1qvejRMnu6IgbYSK0ZrgiBhSOFi55mnu50CZWLllR1nPF_vqw" class=" img-responsive ">
                                <div class="nickname">Nhân viên hỗ trợ</div>
                            </div>
                        </div>
                        <div class="col-md-10 col-xs-10 nopadding">
                            <div class="messages msg_receive">
                                <p>
                                    Chào bạn, tôi có thể giúp gì cho bạn?
                                </p>
                                <time id="firstTime"></time>
                            </div>
                        </div>
                    </div>
                    @* <div class="row msg_container base_sent">
                            <div class="col-md-10 col-xs-10 nopadding">
                                <div class="messages msg_sent">
                                    <p>Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?</p>
                                </div>
                            </div>
                            <div class="col-md-2 col-xs-2 nopadding avatar">
                                <div class="avatar-info">
                                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1qvejRMnu6IgbYSK0ZrgiBhSOFi55mnu50CZWLllR1nPF_vqw" class=" img-responsive ">
                                    <div class="nickname">ID_Khach</div>
                                </div>
                            </div>
                        </div>
                        <div class="row msg_container base_receive">
                            <div class="col-md-2 col-xs-2 nopadding avatar">
                                <div class="avatar-info">
                                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1qvejRMnu6IgbYSK0ZrgiBhSOFi55mnu50CZWLllR1nPF_vqw" class=" img-responsive ">
                                    <div class="nickname">Admin</div>
                                </div>
                            </div>
                            <div class="col-md-10 col-xs-10 nopadding">
                                <div class="messages msg_receive">
                                    <p>
                                        Bạn cho mình xin thông tin tài khoản của bạn với ạ? Bạn cho mình xin thông tin tài khoản của bạn với ạ?
                                        Bạn cho mình xin thông tin tài khoản của bạn với ạ? Bạn cho mình xin thông tin tài khoản của bạn với ạ?
                                    </p>
                                    <time datetime="2019-06-06T13:00">2 phút trước</time>
                                </div>
                            </div>
                        </div>
                        <div class="row msg_container base_receive">
                            <div class="col-md-2 col-xs-2 nopadding avatar">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1qvejRMnu6IgbYSK0ZrgiBhSOFi55mnu50CZWLllR1nPF_vqw" class=" img-responsive ">
                                <div class="nickname">Admin</div>
                            </div>
                            <div class="col-md-10 col-xs-10 nopadding">
                                <div class="messages msg_receive">
                                    <p>Bạn cho mình xin thông tin tài khoản của bạn với ạ?</p>
                                    <time datetime="2019-06-06T13:00">2 phút trước</time>
                                </div>
                            </div>
                        </div>
                        <div class="row msg_container base_sent">
                            <div class="col-md-10 col-xs-10 nopadding">
                                <div class="messages msg_sent">
                                    <p>
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-2 col-xs-2 nopadding avatar">
                                <img src="http://arunoommen.com/wp-content/uploads/2017/01/woman_icon-icons.com_55031.png" class=" img-responsive ">
                                <div class="nickname">ID_Khach</div>
                            </div>
                        </div>
                        <div class="row msg_container base_sent">
                            <div class="col-md-10 col-xs-10 nopadding">
                                <div class="messages msg_sent">
                                    <p>
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                        Tại sao tôi nạp tiền rồi mà chưa nhận được trong tài khoản?
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-2 col-xs-2 nopadding avatar">
                                <img src="http://arunoommen.com/wp-content/uploads/2017/01/woman_icon-icons.com_55031.png" class=" img-responsive ">
                                <div class="nickname">ID_Khach</div>
                            </div>
                        </div>*@
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input id="txt-input" type="text" class="form-control input-sm chat_input" placeholder="Nhập tin nhắn ở đây..." />
                        <span class="input-group-btn">
                            <button class="btn btn-primary btn-sm" id="btn-chat">Gửi</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>